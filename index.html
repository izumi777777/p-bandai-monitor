<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB Monitor - Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="text-slate-900">

    <!-- Header -->
    <nav class="sticky top-0 z-40 bg-white/70 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-orange-500 p-2 rounded-xl text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
            </div>
            <h1 class="text-xl font-extrabold tracking-tight">PB Monitor</h1>
        </div>
        <button id="settingsBtn" class="p-2.5 text-slate-500 hover:bg-slate-100 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
    </nav>

    <div class="max-w-3xl mx-auto px-6 pt-8">
        <!-- Input Area -->
        <div class="bg-white p-2 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100 flex flex-col sm:flex-row gap-2 mb-8">
            <input id="urlInput" type="text" placeholder="プレバンの商品URLを貼り付け..." class="flex-1 px-6 py-4 bg-transparent outline-none text-slate-700">
            <button id="addBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-[1.6rem] font-bold flex items-center justify-center gap-2 transition-all">
                <span id="btnIcon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg></span>
                <span>追加</span>
            </button>
        </div>

        <div id="statusLabel" class="hidden text-center mb-6 text-orange-500 text-sm font-bold animate-pulse flex items-center justify-center gap-2">
            AIがページを解析中...
        </div>

        <!-- List -->
        <div id="itemsList" class="grid gap-4">
            <!-- Items injected here -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">APIキーの設定</h2>
            <p class="text-slate-500 text-sm mb-6">Google Gemini APIキーを入力してください。</p>
            <input id="apiKeyInput" type="password" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-orange-500 outline-none mb-4">
            <button id="saveKeyBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800">保存して閉じる</button>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const addBtn = document.getElementById('addBtn');
        const itemsList = document.getElementById('itemsList');
        const statusLabel = document.getElementById('statusLabel');
        const modal = document.getElementById('modal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const settingsBtn = document.getElementById('settingsBtn');

        let items = JSON.parse(localStorage.getItem('pb_monitor_items') || '[]');
        let apiKey = localStorage.getItem('pb_monitor_key') || '';

        if (!apiKey) modal.classList.remove('hidden');

        function saveItems() {
            localStorage.setItem('pb_monitor_items', JSON.stringify(items));
            render();
        }

        async function analyzeUrl(targetUrl) {
            if (!apiKey) {
                modal.classList.remove('hidden');
                return;
            }

            statusLabel.classList.remove('hidden');
            addBtn.disabled = true;
            addBtn.classList.add('opacity-50');

            try {
                const prompt = `Analyze this Premium Bandai Japan product URL: ${targetUrl}. Extract JSON: {"name": "Product Name", "price": "Price with Yen", "status": "Stock status like 予約受付中 or 在庫なし"}. ONLY return JSON.`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(text.match(/\{.*\}/s)[0]);

                items.unshift({
                    id: Date.now(),
                    url: targetUrl,
                    ...json,
                    lastChecked: new Date().toLocaleTimeString('ja-JP')
                });

                urlInput.value = '';
                saveItems();
            } catch (err) {
                alert('解析に失敗しました。URLまたはAPIキーを確認してください。');
                console.error(err);
            } finally {
                statusLabel.classList.add('hidden');
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50');
            }
        }

        function render() {
            if (items.length === 0) {
                itemsList.innerHTML = `<div class="text-center py-20 bg-slate-100 rounded-[3rem] text-slate-400">監視リストは空です</div>`;
                return;
            }

            itemsList.innerHTML = items.map(item => `
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm relative group">
                    <button onclick="removeItem(${item.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                    <div class="mb-2">
                        <span class="px-3 py-1 text-[10px] font-bold rounded-full ${item.status.includes('受付中') ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500'}">
                            ${item.status}
                        </span>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-4 line-clamp-2">${item.name}</h3>
                    <div class="flex items-end justify-between pt-4 border-t border-slate-50">
                        <div>
                            <div class="text-xl font-black">${item.price}</div>
                            <div class="text-[10px] text-slate-400">更新: ${item.lastChecked}</div>
                        </div>
                        <a href="${item.url}" target="_blank" class="p-3 bg-slate-50 rounded-xl hover:bg-orange-500 hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        window.removeItem = (id) => {
            items = items.filter(i => i.id !== id);
            saveItems();
        };

        addBtn.onclick = () => {
            if (urlInput.value) analyzeUrl(urlInput.value);
        };

        saveKeyBtn.onclick = () => {
            apiKey = apiKeyInput.value;
            localStorage.setItem('pb_monitor_key', apiKey);
            modal.classList.add('hidden');
        };

        settingsBtn.onclick = () => {
            apiKeyInput.value = apiKey;
            modal.classList.remove('hidden');
        };

        render();
    </script>
</body>
</html>