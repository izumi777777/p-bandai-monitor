<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PB Monitor</title>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-slate-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const STORAGE_KEY = "pb_monitor_items";
    const CONFIG_KEY = "pb_monitor_config";

    // Lucide Icon Component wrapper
    const Icon = ({ name, size = 18, className = "" }) => {
      useEffect(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, [name]);
      return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
    };

    function App() {
      const [items, setItems] = useState([]);
      const [url, setUrl] = useState("");
      const [apiKey, setApiKey] = useState("");
      const [isConfigOpen, setIsConfigOpen] = useState(false);
      const [loading, setLoading] = useState(false);

      // 初期化: ローカルストレージから復元
      useEffect(() => {
        try {
          const storedItems = localStorage.getItem(STORAGE_KEY);
          if (storedItems) setItems(JSON.parse(storedItems));

          const storedConfig = localStorage.getItem(CONFIG_KEY);
          if (storedConfig) {
            const config = JSON.parse(storedConfig);
            setApiKey(config.apiKey || "");
          }
        } catch (e) {
          console.error("Failed to load data", e);
        }
      }, []);

      // アイテム更新時に保存
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      }, [items]);

      const saveConfig = () => {
        localStorage.setItem(CONFIG_KEY, JSON.stringify({ apiKey }));
        setIsConfigOpen(false);
        console.log("Configuration saved.");
      };

      // APIによる解析シミュレーション/実行
      const analyzeProduct = async (itemId, targetUrl) => {
        console.log(`[Analysis Start] Item ID: ${itemId}, URL: ${targetUrl}`);
        
        if (!apiKey) {
          console.warn("[Analysis Aborted] Gemini API Key is not set. Please set it in settings.");
          setItems(prev => prev.map(item => 
            item.id === itemId ? { ...item, status: "APIキー未設定", price: "エラー" } : item
          ));
          return;
        }

        try {
          // 本来はここでGemini APIを叩く (fetch)
          // 今回はログ出力の実装にフォーカスするため、解析中の進捗をコンソールに出力します
          console.log(`[Analysis Progress] Fetching content from ${targetUrl}...`);
          
          // 擬似的な遅延
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          console.log(`[Analysis Progress] Analyzing page structure with Gemini API...`);
          
          await new Promise(resolve => setTimeout(resolve, 1500));

          // 成功時のダミーデータ更新
          setItems(prev => prev.map(item => 
            item.id === itemId ? { 
              ...item, 
              name: "解析済み商品サンプル", 
              price: "¥2,980", 
              status: "監視中",
              lastUpdated: new Date().toLocaleString('ja-JP')
            } : item
          ));
          
          console.log(`[Analysis Success] Item ID: ${itemId} has been updated.`);
        } catch (error) {
          console.error(`[Analysis Error] Failed to analyze ${targetUrl}:`, error);
          setItems(prev => prev.map(item => 
            item.id === itemId ? { ...item, status: "解析失敗", price: "エラー" } : item
          ));
        }
      };

      const addItem = () => {
        if (!url.trim()) return;
        
        const newItem = {
          id: Date.now(),
          url: url.trim(),
          name: "解析リクエスト送信済み...",
          price: "解析中...",
          status: "待機中",
          lastUpdated: new Date().toLocaleString('ja-JP')
        };

        setItems(prev => [newItem, ...prev]);
        setUrl("");

        // 解析プロセスの開始
        analyzeProduct(newItem.id, newItem.url);
      };

      const deleteItem = (id) => {
        console.log(`[System] Deleting item: ${id}`);
        setItems(prev => prev.filter(item => item.id !== id));
      };

      return (
        <div className="max-w-2xl mx-auto p-4 md:p-8">
          <header className="flex justify-between items-center mb-8 border-b pb-4">
            <div className="flex items-center gap-2">
              <Icon name="package-search" size={28} className="text-blue-600" />
              <h1 className="text-2xl font-bold text-slate-800 tracking-tight">PB Monitor</h1>
            </div>
            <button 
              onClick={() => setIsConfigOpen(!isConfigOpen)}
              className="p-2 hover:bg-slate-200 rounded-full transition-colors"
            >
              <Icon name="settings" className="text-slate-600" />
            </button>
          </header>

          {/* 設定パネル */}
          {isConfigOpen && (
            <div className="bg-white border border-slate-200 p-5 rounded-xl shadow-sm mb-8 animate-in fade-in slide-in-from-top-2">
              <h2 className="text-sm font-semibold text-slate-700 mb-3">API 設定 (Gemini API)</h2>
              <div className="flex flex-col gap-3">
                <input
                  className="w-full border border-slate-300 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  type="password"
                  placeholder="ここにAPIキーを入力"
                  value={apiKey}
                  onChange={e => setApiKey(e.target.value)}
                />
                <div className="flex justify-end gap-2">
                  <button 
                    onClick={() => setIsConfigOpen(false)}
                    className="text-sm px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                  >
                    キャンセル
                  </button>
                  <button 
                    onClick={saveConfig}
                    className="text-sm bg-slate-900 text-white px-5 py-2 rounded-lg font-medium hover:bg-black transition-colors"
                  >
                    保存する
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 入力エリア */}
          <div className="flex gap-2 mb-8 group">
            <div className="relative flex-1">
              <input
                className="w-full border border-slate-300 p-3 pl-4 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="Amazonや楽天のURLを貼り付け"
                value={url}
                onChange={e => setUrl(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && addItem()}
              />
            </div>
            <button 
              onClick={addItem}
              disabled={!url}
              className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center gap-2 whitespace-nowrap"
            >
              <Icon name="plus" size={20} />
              追加
            </button>
          </div>

          {/* リスト表示 */}
          <div className="space-y-3">
            {items.length === 0 ? (
              <div className="text-center py-20 border-2 border-dashed border-slate-200 rounded-3xl">
                <Icon name="clipboard-list" size={48} className="mx-auto text-slate-300 mb-4" />
                <p className="text-slate-400 font-medium">監視中の商品はまだありません</p>
              </div>
            ) : (
              items.map(item => (
                <div key={item.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-200 transition-all flex items-center gap-4 group">
                  <div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 shrink-0">
                    <Icon name="shopping-bag" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="font-bold text-slate-800 truncate leading-tight mb-1">{item.name}</div>
                    <div className="flex items-center gap-3 text-xs text-slate-500">
                      <span className="flex items-center gap-1">
                        <Icon name="clock" size={12} /> {item.lastUpdated}
                      </span>
                      <span className={`px-2 py-0.5 rounded-full ${
                        item.status === '待機中' ? 'bg-slate-100 text-slate-600' : 
                        item.status === '監視中' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'
                      }`}>
                        {item.status}
                      </span>
                    </div>
                  </div>
                  <div className="text-right mr-2">
                    <div className="text-lg font-black text-slate-900">{item.price}</div>
                  </div>
                  <button 
                    onClick={() => deleteItem(item.id)}
                    className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100"
                  >
                    <Icon name="trash-2" size={20} />
                  </button>
                </div>
              ))
            )}
          </div>
          
          <footer className="mt-12 text-center text-slate-400 text-xs">
            &copy; 2024 PB Monitor - Simple Stock Tracker
          </footer>
        </div>
      );
    }

    // React 18 Render setup
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>