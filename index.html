<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éó„É¨„Éê„É≥Áõ£Ë¶ñ„Åè„Çì on GitHub Pages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, onSnapshot, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Configuration ---
        // GitHub Pages„ÅßÂãï„Åã„Åô„Åü„ÇÅ„ÄÅÁí∞Â¢ÉÂ§âÊï∞„ÅÆ‰ª£„Çè„Çä„Å´Áõ¥Êé•ÂÆöÁæ©„Åô„Çã„Åã„ÄÅ„Éì„É´„ÉâÊôÇ„Å´Âüã„ÇÅËæº„Åø„Åæ„Åô„ÄÇ
        const firebaseConfig = JSON.parse('__firebase_config');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pbandai-monitor-gh';
        const apiKey = ""; // Gemini API Key

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Alpine.js for UI Logic ---
        document.addEventListener('alpine:init', () => {
            Alpine.data('monitorApp', () => ({
                user: null,
                keywords: [],
                newKeyword: '',
                isChecking: false,
                loading: true,

                async init() {
                    // Auth logic (Rule 3)
                    onAuthStateChanged(auth, (user) => {
                        this.user = user;
                        if (user) {
                            this.syncData();
                        } else {
                            signInAnonymously(auth);
                        }
                    });
                },

                syncData() {
                    if (!this.user) return;
                    const q = collection(db, 'artifacts', appId, 'users', this.user.uid, 'monitors');
                    onSnapshot(q, (snapshot) => {
                        this.keywords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.loading = false;
                    }, (err) => {
                        console.error("Firestore Error:", err);
                        this.loading = false;
                    });
                },

                async addKeyword() {
                    if (!this.newKeyword.trim() || !this.user) return;
                    await addDoc(collection(db, 'artifacts', appId, 'users', this.user.uid, 'monitors'), {
                        keyword: this.newKeyword,
                        lastStatus: "Êú™Á¢∫Ë™ç„Åß„Åô„ÄÇ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Å≠‚ô™",
                        lastChecked: null,
                        sources: []
                    });
                    this.newKeyword = '';
                },

                async deleteKeyword(id) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', this.user.uid, 'monitors', id));
                },

                async checkStatus(id, keyword) {
                    if (this.isChecking) return;
                    this.isChecking = true;

                    const result = await this.callGeminiAI(keyword);
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'users', this.user.uid, 'monitors', id), {
                        lastStatus: result.text,
                        lastChecked: serverTimestamp(),
                        sources: result.sources || []
                    });

                    this.isChecking = false;
                },

                async callGeminiAI(keyword) {
                    const systemPrompt = "„ÅÇ„Å™„Åü„ÅØ„Éó„É¨„Éü„Ç¢„É†„Éê„É≥„ÉÄ„Ç§„ÅÆÂú®Â∫´Áä∂Ê≥Å„ÇíÊ≠£Á¢∫„Å´Âà§Êñ≠„Åô„ÇãÂä©Êâã„Åß„Åô„ÄÇGoogleÊ§úÁ¥¢„ÅÆÁµêÊûú„Åã„Çâ„ÄÅÁâπÂÆö„ÅÆÂïÜÂìÅ„Åå„Äå‰∫àÁ¥ÑÂèó‰ªò‰∏≠„Äç„ÄåÂú®Â∫´„ÅÇ„Çä„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„Äå‰∫àÁ¥ÑÁµÇ‰∫Ü„Äç„ÄåÂú®Â∫´„Å™„Åó„Äç„Åã„ÇíÂà§Êñ≠„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊ∏ÖÊ•ö„Å™Â•≥Â≠êÂ§ßÁîüÈ¢®„Å´Áü≠„ÅèÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                    const userQuery = `„Éó„É¨„Éü„Ç¢„É†„Éê„É≥„ÉÄ„Ç§(p-bandai.jp)„Åß„Äå${keyword}„Äç„ÅÆÊúÄÊñ∞„ÅÆË≤©Â£≤Áä∂Ê≥Å„ÇíË™ø„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∫àÁ¥ÑÈñãÂßã„ÇÑÂÜçË≤©„ÅÆÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Êïô„Åà„Å¶„ÄÇ`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: [{ "google_search": {} }]
                    };

                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        return {
                            text: data.candidates?.[0]?.content?.parts?.[0]?.text || "ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
                            sources: data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title })) || []
                        };
                    } catch (err) {
                        return { text: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å°„ÇÉ„ÅÑ„Åæ„Åó„Åü„ÄÇÊôÇÈñì„ÇíÁΩÆ„ÅÑ„Å¶Ë©¶„Åó„Å¶„Åø„Å¶„Å≠„ÄÇ", sources: [] };
                    }
                }
            }));
        });
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
    </style>
</head>
<body class="bg-[#FFF5F7] text-[#5D4E54] min-h-screen" x-data="monitorApp">

    <div class="max-w-2xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-white rounded-[2rem] p-6 shadow-sm border border-pink-100 mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-pink-500 flex items-center gap-2">
                    <span>üå∏</span> „Éó„É¨„Éê„É≥Áõ£Ë¶ñ„Åè„Çì
                </h1>
                <p class="text-xs text-pink-300">GitHub Pages„ÅßÂèØÊÑõ„ÅèÂãï‰Ωú‰∏≠‚ô™</p>
            </div>
            <div class="text-right text-[10px] text-pink-200" x-text="'UID: ' + (user ? user.uid.slice(0,8) : '...')"></div>
        </header>

        <!-- Input Section -->
        <div class="mb-10">
            <div class="relative flex gap-2">
                <input 
                    type="text" 
                    x-model="newKeyword"
                    @keyup.enter="addKeyword"
                    placeholder="‰æãÔºöHG 1/144 „Éè„Ç§„Ç¥„ÉÉ„ÇØ" 
                    class="w-full bg-white border-none rounded-2xl px-6 py-4 shadow-sm ring-1 ring-pink-100 focus:ring-2 focus:ring-pink-400 outline-none transition-all placeholder:text-pink-100"
                >
                <button 
                    @click="addKeyword"
                    class="bg-pink-400 text-white px-8 py-4 rounded-2xl font-bold hover:bg-pink-500 transition-all shadow-lg shadow-pink-100 active:scale-95"
                >
                    ËøΩÂä†
                </button>
            </div>
        </div>

        <!-- List Section -->
        <div class="space-y-4">
            <template x-if="loading">
                <div class="text-center py-10 text-pink-300">Ë™≠„ÅøËæº„Åø‰∏≠„Å†„Çà...</div>
            </template>

            <template x-for="item in keywords" :key="item.id">
                <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-pink-50 transition-all hover:shadow-md">
                    <!-- Card Top -->
                    <div class="px-6 py-4 bg-pink-50/30 border-b border-pink-50 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-pink-400"></div>
                            <span class="font-bold text-lg" x-text="item.keyword"></span>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                @click="checkStatus(item.id, item.keyword)"
                                :disabled="isChecking"
                                class="bg-white px-4 py-1.5 rounded-full text-xs font-bold text-pink-500 shadow-sm ring-1 ring-pink-100 hover:bg-pink-50 disabled:opacity-50 flex items-center gap-1"
                            >
                                <span :class="isChecking ? 'animate-spin inline-block' : ''">üîÑ</span> AI„ÅßÁ¢∫Ë™ç
                            </button>
                            <button @click="deleteKeyword(item.id)" class="text-pink-100 hover:text-pink-400 transition-colors">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    <!-- Card Content -->
                    <div class="p-6">
                        <div class="bg-[#FDF9FA] rounded-2xl p-4 mb-4">
                            <p class="text-[10px] font-bold text-pink-300 mb-1 uppercase tracking-widest">AI Status Report</p>
                            <p class="text-sm leading-relaxed" x-text="item.lastStatus"></p>
                        </div>

                        <!-- Sources -->
                        <div class="flex flex-wrap gap-2 mb-4" x-show="item.sources && item.sources.length > 0">
                            <template x-for="src in item.sources">
                                <a :href="src.uri" target="_blank" class="text-[10px] bg-white border border-pink-100 px-2 py-1 rounded-lg text-pink-400 hover:bg-pink-50 flex items-center gap-1">
                                    üîó <span x-text="src.title.slice(0, 15) + '...'"></span>
                                </a>
                            </template>
                        </div>

                        <div class="text-[9px] text-pink-200 text-right italic" x-text="item.lastChecked ? 'ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ: ' + new Date(item.lastChecked.seconds * 1000).toLocaleString() : 'Êú™„ÉÅ„Çß„ÉÉ„ÇØ'"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center">
            <div class="inline-block bg-white/50 px-6 py-2 rounded-full text-[10px] text-pink-300 border border-pink-50">
                AI powered by Gemini 2.5 Flash ‚Ä¢ No Server Required
            </div>
        </footer>
    </div>

</body>
</html>