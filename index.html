<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PB Monitor (Azure OpenAI)</title>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const STORAGE_ITEMS = "pb_monitor_items_azure";
    const STORAGE_CONFIG = "pb_azure_config";

    const Icon = {
      Plus: () => (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
          <path d="M12 5v14M5 12h14" />
        </svg>
      ),
      Trash: () => (
        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
          <path d="M3 6h18M8 6v14m8-14v14M5 6l1-3h12l1 3" />
        </svg>
      ),
      Gear: () => (
        <svg className="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
          <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"/>
          <path d="M19.4 15a1.6 1.6 0 0 0 .3 1.7l.1.1a2 2 0 0 1-2.8 2.8l-.1-.1a1.6 1.6 0 0 0-1.7-.3 1.6 1.6 0 0 0-1 1.5V21a2 2 0 0 1-4 0v-.1a1.6 1.6 0 0 0-1-1.5 1.6 1.6 0 0 0-1.7.3l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1.6 1.6 0 0 0 .3-1.7 1.6 1.6 0 0 0-1.5-1H3a2 2 0 0 1 0-4h.1a1.6 1.6 0 0 0 1.5-1 1.6 1.6 0 0 0-.3-1.7l-.1-.1a2 2 0 1 1 2.8-2.8l.1.1a1.6 1.6 0 0 0 1.7.3a1.6 1.6 0 0 0 1-1.5V3a2 2 0 0 1 4 0v-.1a1.6 1.6 0 0 0 1.0 1.5 1.6 1.6 0 0 0 1.7-.3l.1-.1a2 2 0 1 1 2.8 2.8l-.1.1a1.6 1.6 0 0 0-.3 1.7 1.6 1.6 0 0 0 1.5 1H21a2 2 0 0 1 0 4h-.1a1.6 1.6 0 0 0-1.5 1z"/>
        </svg>
      ),
      Refresh: () => (
        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
          <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      ),
      Download: () => (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
          <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
      )
    };

    function App() {
      const [items, setItems] = useState([]);
      const [url, setUrl] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [showConfig, setShowConfig] = useState(false);

      const [config, setConfig] = useState({
        endpoint: "https://test-ms-ai-japaneast-structure.openai.azure.com/",
        apiKey: "",
        deploymentName: "test-ms-gpt4o-structure",
        apiVersion: "2024-12-01-preview"
      });

      useEffect(() => {
        const savedItems = localStorage.getItem(STORAGE_ITEMS);
        const savedConfig = localStorage.getItem(STORAGE_CONFIG);
        if (savedItems) setItems(JSON.parse(savedItems));
        
        if (savedConfig) {
          setConfig(JSON.parse(savedConfig));
        } else {
          setShowConfig(true);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem(STORAGE_ITEMS, JSON.stringify(items));
      }, [items]);

      const saveConfig = () => {
        localStorage.setItem(STORAGE_CONFIG, JSON.stringify(config));
        setShowConfig(false);
        setError("");
      };

      // „É≠„Ç∞„Çí„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„ÇãÊ©üËÉΩ
      const downloadLog = () => {
        if (items.length === 0) return;
        
        const timestamp = new Date().toLocaleString('ja-JP').replace(/[\/\s:]/g, '-');
        const fileName = `pb_monitor_log_${timestamp}.txt`;
        
        let textContent = "--- PB Monitor Ëß£Êûê„É≠„Ç∞ ---\n";
        textContent += `Âá∫ÂäõÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}\n\n`;
        
        items.forEach((item, index) => {
          textContent += `[${index + 1}] ${item.name || '‰∏çÊòé„Å™ÂïÜÂìÅ'}\n`;
          textContent += `URL: ${item.url}\n`;
          textContent += `‰æ°Ê†º: ${item.price || '---'}\n`;
          textContent += `Áä∂ÊÖã: ${item.status || '---'}\n`;
          textContent += `Áô∫ÈÄÅÊôÇÊúü: ${item.delivery_date || '---'}\n`;
          textContent += `Âú®Â∫´/Âà∂Èôê: ${item.stock_count || '---'}\n`;
          textContent += `ÊúÄÁµÇÊõ¥Êñ∞: ${item.lastUpdated}\n`;
          textContent += `------------------------------------------\n`;
        });

        const blob = new Blob([textContent], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(link.href);
      };

      const analyze = async (targetUrl, existingId = null) => {
        if (!config.endpoint || !config.apiKey) {
          setShowConfig(true);
          return setError("API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        }
        if (!targetUrl) return;

        setLoading(true);
        setError("");

        let baseUrl = config.endpoint.trim().replace(/\/+$/, "");
        let apiEndpoint = `${baseUrl}/openai/deployments/${config.deploymentName}/chat/completions?api-version=${config.apiVersion}`;

        const systemPrompt = `„ÅÇ„Å™„Åü„ÅØEC„Çµ„Ç§„Éà„ÅÆÂïÜÂìÅÊÉÖÂ†±„ÇíÊäΩÂá∫„Åô„ÇãÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ
        Êèê‰æõ„Åï„Çå„ÅüURL„Åã„Çâ„ÄÅÊúÄÊñ∞„ÅÆÂïÜÂìÅÂêç„ÄÅ‰æ°Ê†º„ÄÅÂú®Â∫´Áä∂Ê≥Å„ÄÅÁô∫ÈÄÅÊôÇÊúü„ÇíÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        „ÄêÈáçË¶ÅÊåáÁ§∫„Äë
        - „Éó„É¨„Éü„Ç¢„É†„Éê„É≥„ÉÄ„Ç§Á≠â„ÅÆÊó¢Áü•„ÅÆ„Çµ„Ç§„Éà„ÅÆÂ†¥Âêà„ÄÅURLÂÜÖ„ÅÆÊÉÖÂ†±„Åã„ÇâÂïÜÂìÅÂêç„ÇÑ„Ç´„ÉÜ„Ç¥„É™„ÇíÊé®Ê∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        - „É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇ„ÄÅ„Äå„Çè„Åã„Çâ„Å™„ÅÑ„Äç„Å®Á≠î„Åà„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅURLÊñáÂ≠óÂàó„ÇÑ„ÅÇ„Å™„Åü„ÅÆÁü•Ë≠ò„Åã„ÇâÊúÄ„ÇÇÂèØËÉΩÊÄß„ÅÆÈ´ò„ÅÑÊÉÖÂ†±„ÇíJSON„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        - Âá∫Âäõ„ÅØÂøÖ„ÅöÁ¥îÁ≤ã„Å™JSON„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà1„Å§„Å†„Åë„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        „ÄêJSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Äë
        {
          "name": "ÂïÜÂìÅÂêç",
          "price": "Á®éËæº‰æ°Ê†º (‰æã: 5,500ÂÜÜ)",
          "stock_count": "Âú®Â∫´Êï∞„Åæ„Åü„ÅØÂà∂Èôê (‰æã: „Åä‰∏Ä‰∫∫Êßò3ÂÄã„Åæ„Åß)",
          "is_preorder": true/false,
          "status": "Âú®Â∫´Áä∂Ê≥ÅÔºà‰∫àÁ¥ÑÂèó‰ªò‰∏≠ / Âú®Â∫´„ÅÇ„Çä / „Å™„Åó Á≠âÔºâ",
          "delivery_date": "Áô∫ÈÄÅÊôÇÊúü"
        }`;

        const userPrompt = `URL: ${targetUrl}\n„Åì„ÅÆÂïÜÂìÅ„ÅÆÊÉÖÂ†±„ÇíËß£Êûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

        const callApiWithBackoff = async (attempt = 0) => {
          try {
            const response = await fetch(apiEndpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "api-key": config.apiKey
              },
              body: JSON.stringify({
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ],
                response_format: { type: "json_object" },
                temperature: 0.2
              })
            });

            const data = await response.json();
            
            if (!response.ok) {
              if (response.status === 429 && attempt < 3) {
                await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 2000));
                return callApiWithBackoff(attempt + 1);
              }
              throw new Error(data.error?.message || `HTTP ${response.status}`);
            }
            return data;
          } catch (e) { throw e; }
        };

        try {
          const data = await callApiWithBackoff();
          console.log("Azure OpenAI Raw Response:", data);

          let content = data.choices?.[0]?.message?.content;
          if (!content) throw new Error("AI„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åß„Åô„ÄÇ");

          content = content.replace(/```json/g, "").replace(/```/g, "").trim();
          const result = JSON.parse(content);
          
          const updateTime = new Date().toLocaleString('ja-JP');

          if (existingId) {
            setItems(prev => prev.map(item => 
              item.id === existingId ? { ...item, ...result, lastUpdated: updateTime } : item
            ));
          } else {
            setItems(prev => [{ id: Date.now(), url: targetUrl, ...result, lastUpdated: updateTime }, ...prev]);
            setUrl("");
          }
        } catch (e) {
          console.error("Analysis Error:", e);
          setError(`Ëß£Êûê„Ç®„É©„Éº: ${e.message}`);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="max-w-3xl mx-auto p-4 md:p-10">
          <header className="flex justify-between items-center mb-10">
            <div className="flex items-center gap-3">
              <div className="bg-sky-600 p-2.5 rounded-xl text-white shadow-lg shadow-sky-200">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24">
                  <path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L5.594 15.06a2 2 0 011.022-.547V7.086a2 2 0 011.022-.547l2.387-.477a6 6 0 013.86-.517l.318.158a6 6 0 003.86.517l2.387.477a2 2 0 001.022.547v7.832z" />
                </svg>
              </div>
              <div>
                <h1 className="text-2xl font-black text-slate-800 tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-slate-800 to-slate-500">PB Monitor</h1>
                <p className="text-[10px] font-bold text-sky-500 uppercase tracking-widest">Azure GPT-4o v2</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button 
                onClick={downloadLog} 
                title="„É≠„Ç∞„Çí‰øùÂ≠ò"
                className="p-2.5 hover:bg-emerald-50 text-emerald-600 rounded-full transition-colors border border-transparent hover:border-emerald-200"
              >
                <Icon.Download />
              </button>
              <button onClick={() => setShowConfig(!showConfig)} className="p-2.5 hover:bg-slate-200 rounded-full transition-colors border border-transparent hover:border-slate-300">
                <Icon.Gear />
              </button>
            </div>
          </header>

          {showConfig && (
            <div className="bg-white p-6 rounded-3xl mb-8 border-2 border-slate-100 shadow-xl space-y-4">
              <h2 className="font-black text-slate-700 flex items-center gap-2">Settings</h2>
              <div className="grid gap-3 text-sm font-bold text-slate-600">
                <input className="w-full p-3 border-2 border-slate-100 rounded-xl outline-none" placeholder="Endpoint URL" value={config.endpoint} onChange={e => setConfig({...config, endpoint: e.target.value})} />
                <input type="password" className="w-full p-3 border-2 border-slate-100 rounded-xl outline-none" placeholder="API Key" value={config.apiKey} onChange={e => setConfig({...config, apiKey: e.target.value})} />
                <div className="grid grid-cols-2 gap-3">
                  <input className="w-full p-3 border-2 border-slate-100 rounded-xl outline-none" placeholder="Deployment" value={config.deploymentName} onChange={e => setConfig({...config, deploymentName: e.target.value})} />
                  <input className="w-full p-3 border-2 border-slate-100 rounded-xl outline-none" placeholder="Version" value={config.apiVersion} onChange={e => setConfig({...config, apiVersion: e.target.value})} />
                </div>
              </div>
              <button onClick={saveConfig} className="w-full bg-sky-600 text-white py-3 rounded-2xl font-black hover:bg-sky-700">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
            </div>
          )}

          <div className="bg-white p-2 rounded-3xl border-2 border-slate-100 shadow-xl mb-10 flex gap-2">
            <input
              className="flex-1 p-4 bg-transparent outline-none text-slate-700 font-medium"
              placeholder="ÂïÜÂìÅURL„ÇíÂÖ•Âäõ"
              value={url}
              onChange={e => setUrl(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && analyze(url)}
            />
            <button
              onClick={() => analyze(url)}
              disabled={loading || !url}
              className="bg-sky-600 hover:bg-sky-700 disabled:bg-slate-200 text-white px-8 py-4 rounded-2xl font-black transition-all flex items-center gap-2"
            >
              {loading ? <div className="animate-spin rounded-full h-5 w-5 border-3 border-white border-t-transparent" /> : <Icon.Plus />}
              ËøΩÂä†
            </button>
          </div>

          {error && (
            <div className="bg-rose-50 border-2 border-rose-100 text-rose-600 p-5 rounded-2xl mb-8 text-sm font-bold">
              <p>‚ö†Ô∏è {error}</p>
            </div>
          )}

          <div className="grid gap-5">
            {items.map(item => (
              <div key={item.id} className="bg-white p-6 rounded-[32px] border-2 border-slate-100 shadow-sm hover:shadow-xl transition-all group relative overflow-hidden">
                <div className="flex justify-between items-start gap-4">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-2">
                      {item.is_preorder && (
                        <span className="bg-orange-500 text-white text-[9px] font-black px-2 py-0.5 rounded-md uppercase tracking-tighter">‰∫àÁ¥ÑÂïÜÂìÅ</span>
                      )}
                      <span className="text-[10px] font-bold text-slate-400">Êõ¥Êñ∞: {item.lastUpdated}</span>
                    </div>
                    <h3 className="font-black text-slate-800 text-lg mb-3 leading-snug">{item.name || "Ëß£Êûê‰∏≠..."}</h3>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div className="bg-slate-50 p-3 rounded-2xl">
                        <div className="text-[10px] text-slate-400 font-bold mb-1">ÁèæÂú®„ÅÆ‰æ°Ê†º</div>
                        <div className="text-xl font-black text-sky-600 tracking-tighter">{item.price || "---"}</div>
                      </div>
                      <div className="bg-slate-50 p-3 rounded-2xl">
                        <div className="text-[10px] text-slate-400 font-bold mb-1">Âú®Â∫´„ÉªÂà∂Èôê</div>
                        <div className="text-sm font-black text-slate-700 uppercase tracking-tight">{item.stock_count || 'Á¢∫Ë™ç‰∏≠'}</div>
                      </div>
                    </div>

                    <div className="flex items-center gap-3 flex-wrap">
                      <span className={`text-[11px] px-4 py-1.5 rounded-full font-black uppercase tracking-wider ${
                        item.status?.includes('„Å™„Åó') || item.status?.includes('ÁµÇ‰∫Ü') || item.status?.includes('ÂÆåÂ£≤') 
                        ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'
                      }`}>
                        {item.status || "Áä∂ÊÖãÁ¢∫Ë™ç‰∏≠"}
                      </span>
                      {item.delivery_date && (
                        <span className="text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">
                          üöö {item.delivery_date}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex flex-col gap-2">
                    <button onClick={() => analyze(item.url, item.id)} disabled={loading} className="p-3 text-slate-400 hover:text-sky-600 hover:bg-sky-50 rounded-2xl transition-all">
                      <Icon.Refresh />
                    </button>
                    <button onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))} className="p-3 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-2xl transition-all opacity-0 group-hover:opacity-100">
                      <Icon.Trash />
                    </button>
                    <a href={item.url} target="_blank" className="p-3 text-slate-400 hover:text-sky-600 hover:bg-sky-50 rounded-2xl transition-all">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                    </a>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>